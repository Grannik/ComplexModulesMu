#define _XOPEN_SOURCE_EXTENDED 1
#include <string.h>
#include <wchar.h>
#include <stdio.h>
#include "tag_termios_mu.h"

// Массив соответствий тегов и ANSI-кодов
const struct TagMapping tag_mappings[] = {
    { TAG_NEWLINE, L"\n", 0 },               // Перенос строки
    { TAG_RESET, L"\033[0m", 1 },            // Сброс всех атрибутов
    { TAG_BLACK, L"\033[30m", 0 },           // Черный текст
    { TAG_RED, L"\033[31m", 0 },             // Красный текст
    { TAG_GREEN, L"\033[32m", 0 },           // Зеленый текст
    { TAG_YELLOW, L"\033[33m", 0 },          // Желтый текст
    { TAG_BLUE, L"\033[34m", 0 },            // Синий текст
    { TAG_MAGENTA, L"\033[35m", 0 },         // Пурпурный текст
    { TAG_CYAN, L"\033[36m", 0 },            // Голубой текст
    { TAG_WHITE, L"\033[37m", 0 },           // Белый текст
    { TAG_GRAY, L"\033[37;2m", 0 },          // Серый текст (с затемнением)
    { TAG_BG_BLACK, L"\033[40m", 0 },        // Черный фон
    { TAG_BG_RED, L"\033[41m", 0 },          // Красный фон
    { TAG_BG_GREEN, L"\033[42m", 0 },        // Зеленый фон
    { TAG_BG_YELLOW, L"\033[43m", 0 },       // Желтый фон
    { TAG_BG_BLUE, L"\033[44m", 0 },         // Синий фон
    { TAG_BG_MAGENTA, L"\033[45m", 0 },      // Пурпурный фон
    { TAG_BG_CYAN, L"\033[46m", 0 },         // Голубой фон
    { TAG_BG_WHITE, L"\033[47m", 0 },        // Белый фон
    { TAG_BOLD, L"\033[1m", 0 },             // Жирный текст
    { TAG_QA, L"\033[30;47m", 0 },           // Белый фон, черный текст
    { TAG_QB, L"\033[31;47m", 0 },           // Белый фон, красный текст
    { TAG_QC, L"\033[32;47m", 0 },           // Белый фон, зеленый текст
    { TAG_QD, L"\033[33;47m", 0 },           // Белый фон, желтый текст
    { TAG_QE, L"\033[34;47m", 0 },           // Белый фон, синий текст
    { TAG_QF, L"\033[35;47m", 0 },           // Белый фон, пурпурный текст
    { TAG_QG, L"\033[36;47m", 0 },           // Белый фон, голубой текст
    { TAG_QH, L"\033[37;47m", 0 },           // Белый фон, белый текст
    { TAG_QI, L"\033[37;2;47m", 0 },         // Белый фон, серый текст
    { TAG_JA, L"\033[30;40m", 0 },           // Черный текст на черном фоне
    { TAG_JB, L"\033[31;40m", 0 },           // Красный текст на черном фоне
    { TAG_JC, L"\033[32;40m", 0 },           // Зеленый текст на черном фоне
    { TAG_JD, L"\033[33;40m", 0 },           // Желтый текст на черном фоне
    { TAG_JE, L"\033[34;40m", 0 },           // Синий текст на черном фоне
    { TAG_JF, L"\033[35;40m", 0 },           // Пурпурный текст на черном фоне
    { TAG_JG, L"\033[36;40m", 0 },           // Голубой текст на черном фоне
    { TAG_JH, L"\033[37;40m", 0 },           // Белый текст на черном фоне
    { TAG_JI, L"\033[37;2;40m", 0 },         // Серый текст на черном фоне
    { TAG_KA, L"\033[30;41m", 0 },           // Черный текст на красном фоне
    { TAG_KB, L"\033[31;41m", 0 },           // Красный текст на красном фоне
    { TAG_KC, L"\033[32;41m", 0 },           // Зеленый текст на красном фоне
    { TAG_KD, L"\033[33;41m", 0 },           // Желтый текст на красном фоне
    { TAG_KE, L"\033[34;41m", 0 },           // Синий текст на красном фоне
    { TAG_KF, L"\033[35;41m", 0 },           // Пурпурный текст на красном фоне
    { TAG_KG, L"\033[36;41m", 0 },           // Голубой текст на красном фоне
    { TAG_KH, L"\033[37;41m", 0 },           // Белый текст на красном фоне
    { TAG_KI, L"\033[37;2;41m", 0 },         // Серый текст на красном фоне
    { TAG_LA, L"\033[30;42m", 0 },           // Черный текст на зелёном фоне
    { TAG_LB, L"\033[31;42m", 0 },           // Красный текст на зелёном фоне
    { TAG_LC, L"\033[32;42m", 0 },           // Зелёный текст на зелёном фоне
    { TAG_LD, L"\033[33;42m", 0 },           // Жёлтый текст на зелёном фоне
    { TAG_LE, L"\033[34;42m", 0 },           // Синий текст на зелёном фоне
    { TAG_LF, L"\033[35;42m", 0 },           // Пурпурный текст на зелёном фоне
    { TAG_LG, L"\033[36;42m", 0 },           // Голубой текст на зелёном фоне
    { TAG_LH, L"\033[37;42m", 0 },           // Белый текст на зелёном фоне
    { TAG_LI, L"\033[37;2;42m", 0 },         // Серый текст на зелёном фоне
    { TAG_MA, L"\033[30;43m", 0 },           // Черный текст на жёлтом фоне
    { TAG_MB, L"\033[31;43m", 0 },           // Красный текст на жёлтом фоне
    { TAG_MC, L"\033[32;43m", 0 },           // Зелёный текст на жёлтом фоне
    { TAG_MD, L"\033[33;43m", 0 },           // Жёлтый текст на жёлтом фоне
    { TAG_ME, L"\033[34;43m", 0 },           // Синий текст на жёлтом фоне
    { TAG_MF, L"\033[35;43m", 0 },           // Пурпурный текст на жёлтом фоне
    { TAG_MG, L"\033[36;43m", 0 },           // Голубой текст на жёлтом фоне
    { TAG_MH, L"\033[37;43m", 0 },           // Белый текст на жёлтом фоне
    { TAG_MI, L"\033[37;2;43m", 0 },         // Серый текст на жёлтом фоне
    { TAG_NA, L"\033[30;44m", 0 },           // Черный текст на синем фоне
    { TAG_NB, L"\033[31;44m", 0 },           // Красный текст на синем фоне
    { TAG_NC, L"\033[32;44m", 0 },           // Зелёный текст на синем фоне
    { TAG_ND, L"\033[33;44m", 0 },           // Жёлтый текст на синем фоне
    { TAG_NE, L"\033[34;44m", 0 },           // Синий текст на синем фоне
    { TAG_NF, L"\033[35;44m", 0 },           // Пурпурный текст на синем фоне
    { TAG_NG, L"\033[36;44m", 0 },           // Голубой текст на синем фоне
    { TAG_NH, L"\033[37;44m", 0 },           // Белый текст на синем фоне
    { TAG_NI, L"\033[37;2;44m", 0 },         // Серый текст на синем фоне
    { TAG_OA, L"\033[30;45m", 0 },           // Черный текст на пурпурном фоне
    { TAG_OB, L"\033[31;45m", 0 },           // Красный текст на пурпурном фоне
    { TAG_OC, L"\033[32;45m", 0 },           // Зелёный текст на пурпурном фоне
    { TAG_OD, L"\033[33;45m", 0 },           // Жёлтый текст на пурпурном фоне
    { TAG_OE, L"\033[34;45m", 0 },           // Синий текст на пурпурном фоне
    { TAG_OF, L"\033[35;45m", 0 },           // Пурпурный текст на пурпурном фоне
    { TAG_OG, L"\033[36;45m", 0 },           // Голубой текст на пурпурном фоне
    { TAG_OH, L"\033[37;45m", 0 },           // Белый текст на пурпурном фоне
    { TAG_OI, L"\033[37;2;45m", 0 },         // Серый текст на пурпурном фоне
    { TAG_PA, L"\033[30;46m", 0 },           // Черный текст на голубом фоне
    { TAG_PB, L"\033[31;46m", 0 },           // Красный текст на голубом фоне
    { TAG_PC, L"\033[32;46m", 0 },           // Зелёный текст на голубом фоне
    { TAG_PD, L"\033[33;46m", 0 },           // Жёлтый текст на голубом фоне
    { TAG_PE, L"\033[34;46m", 0 },           // Синий текст на голубом фоне
    { TAG_PF, L"\033[35;46m", 0 },           // Пурпурный текст на голубом фоне
    { TAG_PG, L"\033[36;46m", 0 },           // Голубой текст на голубом фоне
    { TAG_PH, L"\033[37;46m", 0 },           // Белый текст на голубом фоне
    { TAG_PI, L"\033[37;2;46m", 0 },         // Серый текст на голубом фоне
    { TAG_RESET_BLACK, L"\033[39m", 1 },      // Сброс черного текста
    { TAG_RESET_RED, L"\033[39m", 1 },        // Сброс красного текста
    { TAG_RESET_GREEN, L"\033[39m", 1 },      // Сброс зеленого текста
    { TAG_RESET_YELLOW, L"\033[39m", 1 },     // Сброс желтого текста
    { TAG_RESET_BLUE, L"\033[39m", 1 },       // Сброс синего текста
    { TAG_RESET_MAGENTA, L"\033[39m", 1 },    // Сброс пурпурного текста
    { TAG_RESET_CYAN, L"\033[39m", 1 },       // Сброс голубого текста
    { TAG_RESET_WHITE, L"\033[39m", 1 },      // Сброс белого текста
    { TAG_RESET_GRAY, L"\033[22;39m", 1 },    // Сброс серого текста
    { TAG_RESET_BG_BLACK, L"\033[49m", 1 },   // Сброс черного фона
    { TAG_RESET_BG_RED, L"\033[0m", 0 },     // Сброс красного фона |     { TAG_RESET_BG_RED, L"\033[49m", 1 },
    { TAG_RESET_BG_GREEN, L"\033[49m", 1 },   // Сброс зеленого фона
    { TAG_RESET_BG_YELLOW, L"\033[49m", 1 },  // Сброс желтого фона
    { TAG_RESET_BG_BLUE, L"\033[49m", 1 },    // Сброс синего фона
    { TAG_RESET_BG_MAGENTA, L"\033[49m", 1 }, // Сброс пурпурного фона
    { TAG_RESET_BG_CYAN, L"\033[49m", 1 },    // Сброс голубого фона
    { TAG_RESET_BG_WHITE, L"\033[49m", 1 },   // Сброс белого фона
    { TAG_RESET_BOLD, L"\033[22m", 1 },       // Сброс жирного текста
    { NULL, NULL, 0 }                         // Конец массива
};

// Функция для обработки тегов и получения текста с ANSI-кодами
void parse_tags(const wchar_t *input, wchar_t *output, size_t max_output) {
    const wchar_t *ptr = input;
    size_t out_idx = 0;
    output[0] = L'\0';

    while (*ptr && out_idx < max_output - 1) {
        int found_tag = 0;
        for (int j = 0; tag_mappings[j].tag != NULL; j++) {
            size_t tag_len = wcslen(tag_mappings[j].tag);
            if (wcsncmp(ptr, tag_mappings[j].tag, tag_len) == 0) {
                size_t ansi_len = wcslen(tag_mappings[j].ansi_code);
                if (out_idx + ansi_len < max_output - 1) {
                    wcsncpy(&output[out_idx], tag_mappings[j].ansi_code, ansi_len);
                    out_idx += ansi_len;
                }
                ptr += tag_len;
                found_tag = 1;
                break;
            }
        }
        if (!found_tag) {
            if (out_idx < max_output - 1) {
                output[out_idx++] = *ptr;
            }
            ptr++;
        }
    }
    output[out_idx] = L'\0';
}

// Функция для вывода текста с ANSI-кодами
void print_tagged_text(const wchar_t *buf, int x, int y, int max_x) {
    (void)x; // Не используется, для совместимости
    (void)y; // Не используется, для совместимости
    (void)max_x; // Не используется, для совместимости
    wprintf(L"%ls\n", buf);
}
